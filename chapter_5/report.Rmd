---
title: "Replication and extension report"
author: "Andrew Heiss"
date: "November 3, 2015"
output: 
  html_document: 
    css: fixes.css
    highlight: pygments
    theme: flatly
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
source("replicate_models.R")
library(stargazer)
```

# Replication results

Before merging in the new funding, engagement, and NGO data, I wanted to ensure that the models from the original AJPS article were correct and that they replicated in R instead of just Stata. While doing this, I discovered a couple minor issues with the data and the modeling methods.

Beyond these issues, however, the AJPS article is 100% reproducible (except for the robust standard errors, since Stata and R use slightly different algorithms). 

## Bleeding lags

In the original AJPS article, lagged variables were not calculated by country, so values at the boundaries between countries incorrectly bleed over into adjacent countries. For example, here's an excerpt from the US-Canadian border (note: not the *actual* international border), where the logged population for the US in 2011 gets put into Canada 1991:

    name    year    logpop    logpop_1
    US      2010    19.54998  19.54161
    US      2011    19.55720  19.54998
    Canada  1991    NA        19.55720
    Canada  1992    NA        NA

This doesn't cause any problems for the TIP report models in Table 1, since those models are limited to observations after 2000—the incorrect rows are dropped. However, the models for the correlates of shaming and time to criminalization *are* affected, since they include all post-1991 observations. Models 2.1, 2.2, 3.2, 3.5, 4.2, and 4.4 are all affected by this issue.

### Table: Differences in lagging—models 2.1 and 2.2

```{r, results='asis', echo=FALSE}
var.labs <- c("Worse civil liberties", "US aid (logged)", "GDP (logged)", 
              "Total population (logged)", "2000 TIP protocol ratification", 
              "NGO density", "Corruption", "Rule of law", "Constant")
col.labs <- c("Model 2.1<br>(original; bleeding lags)", "Model 2.1<br>(corrected lags)", 
              "Model 2.2<br>(original; bleeding lags)", "Model 2.2<br>(corrected lags)")
stargazer(model2.1, model2.1.good, model2.2, model2.2.good, 
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="US Pressure", type="html",
          notes.align="l",
          notes=c("Logit model; odds ratios reported. Non-robust standard errors in parentheses. All explanatory variables are lagged one period."))
```

### Table: Differences in lagging—models 3.2 and 3.5

```{r, results='asis', echo=FALSE}
var.labs <- c("In report", "Share of women in parliament", "Worse civil liberties",
              "Regional density of criminalization", "2000 TIP protocol ratification",
              "Missing information (t−2)", "Total population (logged)",
              "NGO density", "GDP per capita (logged)", "Corruption", 
              "US aid as share of GDP", "US aid as share of GDP × In report")
col.labs <- c("Model 3.2<br>(original; bleeding lags)", "Model 3.2<br>(corrected lags)", 
              "Model 3.5<br>(original; bleeding lags)", "Model 3.5<br>(corrected lags)")

ses <- list(sqrt(diag(model3.2$var)), sqrt(diag(model3.2.good$var)), 
            sqrt(diag(model3.5$var)), sqrt(diag(model3.5.good$var)))

extra.lines <- list(c("Number of countries", 
                      c(model3.2.fit["n.max"], model3.2.good.fit["n.max"]),
                      c(model3.5.fit["n.max"], model3.5.good.fit["n.max"])),
                    c("Number of criminalizations", 
                      c(model3.2.fit["events"], model3.2.good.fit["events"]),
                      c(model3.5.fit["events"], model3.5.good.fit["events"])))

stargazer(model3.2, model3.2.good, model3.5, model3.5.good, 
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n", "ll"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Time to Criminalization", 
          se=ses, p.auto=FALSE, type="html",
          notes.align="l", add.lines=extra.lines,
          notes=c("Robust standard errors in parentheses; values differ from published article because of differences in the robustness algorithms Stata and R use. All explanatory variables are lagged one period unless otherwise noted."))
```

### Table: Differences in lagging—models 4.2 and 4.4

```{r, results='asis', echo=FALSE}
var.labs <- c("Tier 1", "Tier 2", "Watch list", "Tier 3", "In report", 
              "First demotion (t−3)", "First demotion (t−2)", 
              "First demotion (t−1)", "Share of women in parliament", 
              "Worse civil liberties", "Regional density of criminalization", 
              "2000 TIP protocol ratification", "Missing information", 
              "Total population (logged)", "NGO density", "US aid (logged)", 
              "GDP per capita (logged)", "Corruption")
col.labs <- c("Model 4.2<br>(original; bleeding lags)", "Model 4.2<br>(corrected lags)",
              "Model 4.4<br>(original; bleeding lags)", "Model 4.4<br>(corrected lags)")

ses <- list(sqrt(diag(model4.2$var)), sqrt(diag(model4.2.good$var)),
            sqrt(diag(model4.4$var)), sqrt(diag(model4.4.good$var)))

extra.lines <- list(c("Number of countries", 
                      c(model4.2.fit["n.max"], model4.2.good.fit["n.max"]),
                      c(model4.4.fit["n.max"], model4.4.good.fit["n.max"])),
                    c("Number of criminalizations", 
                      c(model4.2.fit["events"], model4.2.good.fit["events"]),
                      c(model4.4.fit["events"], model4.4.good.fit["events"])))

stargazer(model4.2, model4.2.good, model4.4, model4.4.good, 
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n", "ll"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Time to Criminalization", 
          se=ses, p.auto=FALSE, type="html",
          notes.align="l", add.lines=extra.lines,
          notes=c("Robust standard errors in parentheses; values differ from published article because of differences in the robustness algorithms Stata and R use. All explanatory variables are lagged one period unless otherwise noted."))
```

## Under-the-hood improvements

By default, Stata and most other statistical packages use the Breslow approximation for handling tied event times. This is because it is the easiest to program and because it works well on older computers. However, according to Terry Therneau,^[Personal correspondence, October 19, 2015.] one of the main inventors of Cox modeling, it is less accurate. With gains in computing power and theoretical statistical work, the Efron approximation is more accurate and more computationally efficient, so in the extensions of the models I use it instead of Breslow. Here's an example of the (fairly minor) differences in the results:

### Table: Differences in tie algorithms—model 1.2

```{r, results='asis', echo=FALSE}
var.labs <- c("Total population (logged)", "Missing information", 
              "NGO density", "Worse civil liberties", 
              "Regional density of criminalization", 
              "2000 TIP protocol ratification")
col.labs <- c("Model 1.2<br>(original; Breslow ties)", "Model 1.2<br>(Efron ties)")

ses <- list(sqrt(diag(model1.2$var)), sqrt(diag(model1.2.good$var)))

extra.lines <- list(c("Number of countries", 
                      c(model1.2.fit["n.max"], model1.2.good.fit["n.max"])),
                    c("Number of inclusions", 
                      c(model1.2.fit["events"], model1.2.good.fit["events"])))

stargazer(model1.2, model1.2.good,
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n", "ll"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Time to Inclusion in Report", 
          se=ses, p.auto=FALSE, type="html",
          notes.align="l", add.lines=extra.lines,
          notes=c("Robust standard errors in parentheses; values differ from published article because of differences in the robustness algorithms Stata and R use. All explanatory variables are lagged one period unless otherwise noted."))
```


# Extension and new findings

I extended the models for inclusion in the TIP report and human trafficking criminalization by adding three new variables individually:  (1) the total amount of funding the US gives to a country in a given year, (2) the level of US State Department engagement in TIP issues (as measured by the frequency of TIP mentions in Wikileaks cables), and (3) the number of known human trafficking NGOs in a given country. 

## Effects of new variables on being included in the TIP report

According to the original article, missing information and trafficking intensity lead to inclusion in the TIP report—countries with more missing information are *less* likely to appear in the report since the State Department cannot know about the severity of trafficking, while countries with worse and more intense visible trafficking are *more* likely to be included.

The new variables add some additional nuance to the selection process, but not much. Funding from the United States has a statistically significant effect, but it most likely because of mathematical issues, given that the hazard ratio is 1 and the standard error is 0—too many country-years with zero funding distorts the model. 

More engagement from the State Department has a significant and substantive positive effect on inclusion in the report, but again, with many caveats. If we measure engagement with the proportion of *observed* TIP-related cables in the Wikileaks dump, for every percent increase in State Department back chatter on trafficking, a country is 17 times more likely to enter the report (`r I(get.parenthetical.stats(model1.5, "prop_tip_wl1", "z"))`). However, if we measure engagement with the *estimated* proportion of TIP-related cables, the effect disappears entirely (`r I(get.parenthetical.stats(model1.6, "prop_tip_estimated1", "z"))`). Additionally, models using cable data are noticeably smaller than other models, with roughly 100 observations in only 24 countries, and the number of inclusions inexplicably exceeds the number of countries—there might be too much missing data. Also, the coefficient for the estimated number of TIP cables is ridiculously huge and most likely wrong.

Replacing the NGO density variable with our own NGO measure—the number of NGOs in each country from the database of human trafficking NGOs we used for the survey—yields a significant but probably non-substantive negative effect of being included in the report. For each additional anti-TIP NGO, a country is 1% less likely to enter the report in a given year (`r I(get.parenthetical.stats(model1.7, "ht_ngos", "z"))`), which is hardly a noticeable effect. Moreover, the count of NGOs is not entirely accurate—it is based on the home location of the NGO, not the location(s) where the NGO actually works. We could use data from the survey to get information about where these NGOs work, but we would have an even smaller set of data to work with.

### Table: The effect of funding, engagement, and NGO density on inclusion in the TIP report

```{r, results='asis', echo=FALSE}
var.labs <- c("Total population (logged)", "Missing information", 
              "NGO density", "Worse civil liberties", 
              "Regional density of criminalization", 
              "2000 TIP protocol ratification", 
              "Trafficking intensity in countries of origin", 
              "Trafficking intensity in transit countries", 
              "Trafficking intensity in destination countries", 
              "Total US funding for TIP", 
              "Proportion of TIP-related cables (observed in Wikileaks)", 
              "Proportion of TIP-related cables (estimated)", 
              "Number of NGOs (survey database)")
col.labs <- c("Model 1.3<br>(from AJPS)", "Model 1.4", 
              "Model 1.5", "Model 1.6", "Model 1.7")

ses <- list(sqrt(diag(model1.3$var)), 
            sqrt(diag(model1.4$var)), sqrt(diag(model1.5$var)),
            sqrt(diag(model1.6$var)), sqrt(diag(model1.7$var)))

extra.lines <- list(c("Number of countries", 
                      c(model1.3.fit["n.max"], 
                        model1.4.fit["n.max"], model1.5.fit["n.max"]),
                      c(model1.6.fit["n.max"], model1.7.fit["n.max"])),
                    c("Number of inclusions", 
                      c(model1.3.fit["events"], 
                        model1.4.fit["events"], model1.5.fit["events"]),
                      c(model1.6.fit["events"], model1.7.fit["events"])))

stargazer(model1.3, model1.4, model1.5, model1.6, model1.7,
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n", "ll"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Time to Inclusion in Report", 
          se=ses, p.auto=FALSE, type="html",
          notes.align="l", add.lines=extra.lines,
          notes=c("Robust standard errors in parentheses. All explanatory variables are lagged one period unless otherwise noted."))
```

## Effects of new variables on criminalization

The original article showed that a number of factors increased the probability that a country criminalized human trafficking in a given year, with inclusion in the TIP report the most potent. The proportion of women in parliament, the respect of civil liberties, the presence of criminalization in neighboring countries, and other variables also had an effect on the likelihood of criminalization. 

Again, the new variables show some promise in explaining the criminalization process, but not much. US TIP funding again has some wonky math issues that I need to look into (with a hazard ratio of 1 and a standard error of 0).

While State Department chatter about TIP issues did influence the decision to include a country in the TIP report (assuming the math is right), it doesn't seem that US engagement in TIP advocacy has an effect on a country's decision to criminalize human trafficking, either measured with observed Wikileaks cables (`r I(get.parenthetical.stats(model3.7, "prop_tip_wl1", "z"))`) or estimated cables (`r I(get.parenthetical.stats(model3.8, "prop_tip_estimated1", "z"))`). 

The presence of more human trafficking NGOs does appear to influence the decision to criminalize though—for each additional NGO with headquarters in a country, the chance that that country will criminalize trafficking increases by 2% (`r I(get.parenthetical.stats(model3.9, "ht_ngos", "z"))`). 

### Table: The effect of funding, engagement, and NGO density on criminalization

```{r, results='asis', echo=FALSE}
var.labs <- c("In report", "Share of women in parliament", "Worse civil liberties",
              "Regional density of criminalization", "2000 TIP protocol ratification",
              "Missing information (t−2)", "Total population (logged)",
              "NGO density", "GDP per capita (logged)", "Corruption",
              "Total US funding for TIP", 
              "Proportion of TIP-related cables (observed in Wikileaks)", 
              "Proportion of TIP-related cables (estimated)", 
              "Number of NGOs (survey database)")
col.labs <- c("Model 3.2<br>(from AJPS)", "Model 3.6", "Model 3.7", 
              "Model 3.8", "Model 3.9")

ses <- list(sqrt(diag(model3.2$var)),
            sqrt(diag(model3.6$var)), sqrt(diag(model3.7$var)), 
            sqrt(diag(model3.8$var)), sqrt(diag(model3.9$var)))

extra.lines <- list(c("Number of countries", 
                      c(model3.2.fit["n.max"],
                        model3.6.fit["n.max"], model3.7.fit["n.max"]),
                      c(model3.8.fit["n.max"], model3.9.fit["n.max"])),
                    c("Number of criminalizations", 
                      c(model3.2.fit["events"],
                        model3.6.fit["events"], model3.7.fit["events"]),
                      c(model3.8.fit["events"], model3.9.fit["events"])))

stargazer(model3.2, model3.6, model3.7, model3.8, model3.9, 
          apply.coef=exp, covariate.labels=var.labs, column.labels=col.labs, 
          keep.stat=c("n", "ll"), model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Time to Criminalization", 
          se=ses, p.auto=FALSE, type="html",
          notes.align="l", add.lines=extra.lines,
          notes=c("Robust standard errors in parentheses. All explanatory variables are lagged one period unless otherwise noted."))
```

## Predicting time to criminalization

The current draft of the chapter uses descriptive statistics to show that countries with documented reactions to the TIP report are more likely to follow up with legislative action in the following year. This conclusion is borne out with multivariate statistical analysis. As seen in the models below, countries with a recorded non-media reaction are 77–88% more likely to criminalize human trafficking (model 5.1: `r I(get.parenthetical.stats(model5.1, "L.reactionnomedia", "z"))`; model 5.2: `r I(get.parenthetical.stats(model5.2, "L.reactionnomedia", "z"))`). The intensity of reactions to the report also has an effect—for every additional type of reaction, countries are approximately 20% more likely to criminalize trafficking (`r I(get.parenthetical.stats(model5.3, "L.totalreactionnomedia", "z"))`).

### Table: The effect of reactions to TIP report on criminalization

```{r, results='asis', echo=FALSE}
var.labs <- c("Reactions (no media)", "Total reactions (no media)", 
              "Share of women in parliament", 
              "Total freedom (political rights + civil liberties)", 
              "2000 TIP protocol ratification", "Big aid", 
              "Regional density of criminalization")
col.labs <- c("Model 5.1", "Model 5.2", "Model 5.3", "Model 5.4")

extra.lines <- list(c("Year fixed effects",
                      rep("Yes", 4)),
                    c("Pseudo R-squared",
                      sapply(list(model5.1, model5.2, 
                                  model5.3, model5.4), 
                             calc.pseudo.r.squared)))

stargazer(model5.1, model5.2, model5.3, model5.4,
          covariate.labels=var.labs, column.labels=col.labs,
          model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Criminalization",
          apply.coef=exp, type="html", p.auto=FALSE, omit="factor\\(year",
          keep.stat=c("n", "ll"), 
          notes.align="l", add.lines=extra.lines,
          notes=c("Standard errors in parentheses. All explanatory variables are lagged one period unless otherwise noted."))
```

&nbsp;

When combined with the reactions data, none of the additional variables help explain the variance in time to criminalization. US TIP funding still suffers from the inexplicable math problem. Observed (`r I(get.parenthetical.stats(model5.6, "prop_tip_wl1", "z"))`) and estimated (`r I(get.parenthetical.stats(model5.7, "prop_tip_estimated1", "z"))`) State Department cables on TIP-related matters have no effect, and more human trafficking NGOs in a country does little to influence the passage of criminalization legislation (`r I(get.parenthetical.stats(model5.8, "ht_ngos", "z"))`).

### Table: The effect of reactions to the TIP report *and* funding, engagement, and NGO density on criminalization

```{r, results='asis', echo=FALSE}
var.labs <- c("Total reactions (no media)", 
              "Share of women in parliament", 
              "Total freedom (political rights + civil liberties)", 
              "2000 TIP protocol ratification", "Big aid", 
              "Regional density of criminalization", 
              "Total US funding for TIP", 
              "Proportion of TIP-related cables (observed in Wikileaks)", 
              "Proportion of TIP-related cables (estimated)", 
              "Number of NGOs (survey database)")
col.labs <- c("Model 5.5", "Model 5.6", "Model 5.7", "Model 5.8")

extra.lines <- list(c("Year fixed effects",
                      rep("Yes", 4)),
                    c("Pseudo R-squared",
                      sapply(list(model5.5, model5.6, 
                                  model5.7, model5.8), 
                             calc.pseudo.r.squared)))

stargazer(model5.5, model5.6, model5.7, model5.8,
          covariate.labels=var.labs, column.labels=col.labs,
          model.numbers=FALSE, dep.var.labels.include=FALSE,
          dep.var.caption="Criminalization",
          apply.coef=exp, type="html", p.auto=FALSE, omit="factor\\(year",
          keep.stat=c("n", "ll"), 
          notes.align="l", add.lines=extra.lines,
          notes=c("Standard errors in parentheses. All explanatory variables are lagged one period unless otherwise noted."))
```

## The effect of democracy on criminalization

The chapter draft currently claims that the "relationship between being included in the report and time to criminalization depends on the level of democracy" and that "the models reinforce that the relationship between inclusion in the report and time to criminalization appears to be stronger for less democratic countries." 

Main explanatory variables:

* Scrutiny (in report) (*models 3.1–3.5*)
* Tier 1/2/2.5/3 + demotions (*models 4.1–4.4*)
* Reactions (*models 5.1–5.4*)
* Funding, engagement, NGO density (*models 1.4–1.7; 3.6–3.9; 5.5–5.8*)
* Democracy (*models 6.x–6.x*)

Standard controls:

* women in parliament
* civil liberties
* regional density of criminalization
* 2000 TIP protocol
* missing information
* population | GDP/cap

---


# To do

* Figure out what's going on with useless funding variable
* Figure out what's going on with semi-useless cable variables
* Figure out most theoretically appropriate combinations of explanatory variables for new models
* Check the effect of democracy with both polity and UDS
* Improve, standardize graphics
